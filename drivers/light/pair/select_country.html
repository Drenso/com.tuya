<style type="text/css">
  #tuya-logo {
    position: relative;
    margin: 50px auto;

    font-size: 48px;
    background-color: #F74600;
    border-radius: 100px;
    width: 100px;
    height: 100px;

    display: flex;
    align-items: center;
    justify-content: center;
  }

  #tuya-logo>svg {
    width: 48px;
    height: 48px;
  }

  #tuya-country {
    display: flex;

    border-radius: var(--homey-border-radius-small);
    box-shadow: 0 0 0 1px var(--homey-color-line);
  }

  #tuya-country-flag {
    flex-grow: 0;

    display: flex;
    align-items: center;
    align-content: center;

    width: 24px;
    padding: 8px;
    padding-right: 0;
    font-size: 24px;
    cursor: default;
  }

  #tuya-country-form {
    flex-grow: 1;
  }

  #tuya-country-select {
    box-shadow: none;
  }
</style>

<div class="homey-form-group">
  <div id="tuya-logo">
    <svg
      version="1.1"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      x="0px"
      y="0px"
      viewBox="0 0 256 256"
      enable-background="new 0 0 256 256"
      xml:space="preserve"
    >
      <g>
        <g>
          <path
            fill="#FFFFFF"
            d="M73.2,19.3c-11.9,0-21.5,9.6-21.5,21.5V68h-6.5c-11.9,0-21.5,9.6-21.5,21.5c0,11.9,9.6,21.5,21.5,21.5h6.5V160c0,47.3,38.3,85.8,85.6,86h21.8c11.9,0,21.5-9.6,21.5-21.5c0-11.9-9.6-21.5-21.5-21.5h-21.5c-23.7,0-43-19.2-43-43v-49h48h2.9c11.9,0,18.6-9.6,18.6-21.5c0-11.9-9.6-21.5-21.5-21.5h-48V40.8C94.7,28.9,85.1,19.3,73.2,19.3z"
          />
          <path
            fill="#FFFFFF"
            d="M167.8,53c11.9,0,21.5,9.6,21.5,21.5c0,3.9,3.2,7.2,7.2,7.2c3.9,0,7.2-3.2,7.2-7.2c0-19.8-16-35.8-35.8-35.8c-4,0-7.2,3.2-7.2,7.2S163.8,53,167.8,53L167.8,53z"
          />
          <path
            fill="#FFFFFF"
            d="M167.8,10c-4,0-7.2,3.2-7.2,7.2s3.2,7.2,7.2,7.2c27.7,0,50.1,22.4,50.1,50.1c0,4,3.2,7.2,7.2,7.2c4,0,7.2-3.2,7.2-7.2C232.2,38.9,203.4,10,167.8,10z"
          />
        </g>
      </g>
    </svg>
  </div>
</div>

<div
  id="tuya-country"
  class="homey-form-group"
>
  <div id="tuya-country-flag">üåç</div>
  <div id="tuya-country-form">
    <select
      id="tuya-country-select"
      class="homey-form-select"
      value=""
    >
      <option disabled>Select your country...</option>
    </select>
  </div>
</div>

<div class="homey-form-group">
  <div
    id="tuya-next"
    class="homey-button-primary-shadow-full is-disabled"
  >Continue</div>
</div>

<script type="text/javascript">
  Promise.resolve().then(async () => {
    Homey.showLoadingOverlay();

    const hasSession = await Homey.emit('tuya_has_session');
    if (hasSession) {
      Homey.hideLoadingOverlay();
      Homey.nextView();
      return;
    }

    Homey.setTitle('Select your Country');
    Homey.setSubtitle('This is the same country as your Tuya account.');
    Homey.hideLoadingOverlay();

    // Render Countries Select
    const countries = await Homey.emit('tuya_list_countries');
    const countriesArray = Object.entries(countries).map(([countryCode, country]) => ({
      code: countryCode,
      name: country.name,
      flag: country.flag,
    }));

    // Sort Countries by Name
    countriesArray.sort((a, b) => a.name.localeCompare(b.name));

    // Render Countries Select Options
    for (const country of Object.values(countriesArray)) {
      const option = document.createElement('option');
      option.value = country.code;
      option.textContent = country.name;
      document.getElementById('tuya-country-select').appendChild(option);
    }

    // On Country Select Change
    document.getElementById('tuya-country-select').addEventListener('change', function () {
      document.getElementById('tuya-country-flag').textContent = countries[this.value].flag;
      document.getElementById('tuya-next').classList.remove('is-disabled');
    });

    // On Next Button Click
    document.getElementById('tuya-next').addEventListener('click', function () {
      const countryCode = document.getElementById('tuya-country-select').value;
      if (!countryCode) return;

      this.classList.add('is-loading');
      Homey.emit('tuya_set_country', countryCode)
        .then(() => Homey.nextView())
        .catch(err => Homey.alert(err))
        .finally(() => this.classList.remove('is-loading'));
    });

  }).catch(err => Homey.alert(err));
</script>